machine:
  services:
    - docker
  environment:
    GO15VENDOREXPERIMENT: 1
    GOPATH: $HOME/.go_project/src/github.com/$CIRCLE_PROJECT_USERNAME/$CIRCLE_PROJECT_REPONAME:$GOPATH
  post:
    - sudo rm -rf /usr/local/go
    - if [ ! -e go1.5.2.linux-amd64.tar.gz ]; then wget https://storage.googleapis.com/golang/go1.5.2.linux-amd64.tar.gz; fi
    - sudo tar -C /usr/local -xzf go1.5.2.linux-amd64.tar.gz

dependencies:
  cache_directories:
    - ~/go1.5.2.linux-amd64.tar.gz
    - ~/docker
  override:
    - mkdir -p $HOME/.go_project/src/github.com/$CIRCLE_PROJECT_USERNAME
    - ln -fs $HOME/$CIRCLE_PROJECT_REPONAME $HOME/.go_project/src/github.com/$CIRCLE_PROJECT_USERNAME/$CIRCLE_PROJECT_REPONAME
    - if [[ -e ~/docker/image.tar ]]; then docker load -i ~/docker/image.tar; else docker pull golang:1.5.2 && mkdir -p ~/docker && docker save golang:1.5.2 > ~/docker/image.tar; fi
    - docker pull helphone/database:latest
    - docker build -t helphone/importer_test -f Dockerfile.test .

test:
  override:
    - docker run -d --name db_importer_test helphone/database:latest
    - sleep 8
    - cd $HOME/.go_project/src/github.com/$CIRCLE_PROJECT_USERNAME/$CIRCLE_PROJECT_REPONAME && docker run -it --rm --name importer_test --env GO15VENDOREXPERIMENT=1 --env DB_USERNAME=postgres --env DB_PASSWORD=postgres --env GIT_ACCESS=d8b37dc9afd9cf1b8ab1803657f3331ce413fdcc --link db_importer_test:db helphone/importer_test

deployment:
  hub:
    branch: master
    commands:
      - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS
      - cd $HOME/.go_project/src/github.com/$CIRCLE_PROJECT_USERNAME/$CIRCLE_PROJECT_REPONAME && go build -o importer main.go
      - docker build -t $CIRCLE_PROJECT_USERNAME/$CIRCLE_PROJECT_REPONAME .
      - docker push $CIRCLE_PROJECT_USERNAME/$CIRCLE_PROJECT_REPONAME
